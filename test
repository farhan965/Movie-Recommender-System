

WITH WAL_AD_VEH AS(SELECT [AS_OF_DATE]
      ,[CONTACT_ID]
      ,[CRD_NUMBER]
      ,[ASSET_CLASS]
      ,[VEHICLE_WRAPPER]
      ,try_cast([SALES_RANK_90DAY] as int)[SALES_RANK_90DAY]
      ,try_cast([SALES_SCORE_90DAY] as int)[SALES_SCORE_90DAY]
      ,try_cast([SALES_RANK_180DAY] as int)[SALES_RANK_180DAY]
      ,try_cast([SALES_SCORE_180DAY] as int)[SALES_SCORE_180DAY]
      ,try_cast([SALES_RANK_12MO] as int)[SALES_RANK_12MO]
      ,try_cast([SALES_SCORE_12MO]as decimal (15,2))[SALES_SCORE_12MO]
      ,try_cast([SALES_12MO]as decimal(15,2))[SALES_12MO]
      ,try_cast([SALES_FREQUENCY]as int)[SALES_FREQUENCY]
      ,try_cast([LAST_PURCHASE]as date)[LAST_PURCHASE]
      ,try_cast([MAX_PURCHASE]as decimal(15,2))[MAX_PURCHASE]
      ,[NEW_MANAGER]
      ,try_cast([RANK_AUM] as int)[RANK_AUM]
      ,try_cast([AUM_SCORE] as int)[AUM_SCORE]
      ,try_cast([AUM]as decimal(15,2))[AUM]
      ,try_cast([REDS_RANK_90DAY] as int)[REDS_RANK_90DAY]
      ,try_cast([REDS_SCORE_90DAY] as int)[REDS_SCORE_90DAY]
      ,try_cast([REDS_RANK_180DAY] as int)[REDS_RANK_180DAY]
      ,try_cast([REDS_SCORE_180DAY]as int)[REDS_SCORE_180DAY]
      ,try_cast([REDS_RANK_12MO] as int)[REDS_RANK_12MO]
      ,try_cast([REDS_SCORE_12MO] as int)[REDS_SCORE_12MO]
      ,try_cast([REDS_12MO]as decimal(15,2))[REDS_12MO]
      ,try_cast([REDS_FREQUENCY]as int)[REDS_FREQUENCY]
      ,try_cast([LAST_RED]as date)[LAST_RED]
      ,try_cast([MAX_RED]as decimal(15,2))[MAX_RED]
      ,try_cast([SALES_GROWTH_YR]as decimal(6,0))[SALES_GROWTH_YR]
      ,try_cast([SALES_MOMENTUM_SCORE]as int)[SALES_MOMENTUM_SCORE]
      ,[PRODUCT_FAMILY_ID]
  FROM [TEST].[Alts_Enhanced2_AdvisorVehicle_TEST]
  Where AS_OF_DATE = (Select MAX(AS_OF_DATE) from [TEST].[Alts_Enhanced2_AdvisorVehicle_TEST]))
  SELECT --ae.[FIRM_ID]
      --,ae.[OFFICE_ID],
      ae.[CONTACT_ID]
      ,ae.[MAX_PURCHASE]
	  ,ae.[SALES_RANK_12MO] 
      ,ae.[SALES_12MO]
	  ,CASE WHEN ASSET_CLASS='Credit' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_cred_inter_Filled
	   ,CASE WHEN ASSET_CLASS='Credit' and VEHICLE_WRAPPER='Non-traded BDC' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_cred_bdc_Filled
	   ,CASE WHEN ASSET_CLASS='Credit' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_cred_oper_Filled
	   ,CASE WHEN ASSET_CLASS='Other' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_other_oper_Filled
	   ,CASE WHEN ASSET_CLASS='Other' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_other_inter_Filled
	   ,CASE WHEN ASSET_CLASS='PE (Core)' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_pecore_inter_Filled
	   ,CASE WHEN ASSET_CLASS='PE (Core)' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_pecore_oper_Filled
	   ,CASE WHEN ASSET_CLASS='PE (Infra)' and VEHICLE_WRAPPER='PE (Infra)' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_peinfra_pe_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_real_inter_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_real_oper_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='DST 1031 - Opportunity Zone Fund' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_real_dstop_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Non-traded REIT' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_real_reit_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Reg D (506b/506c)' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_real_reg_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='DST/QOZ' THEN
			CASE WHEN ae.[SALES_12MO] <> 0 OR ae.[SALES_RANK_12MO] = 0 THEN ae.[SALES_12MO] 
	        ELSE ae12mo.[SALES_12MO] END
       END SALES_12MO_real_dstqoz_Filled
      ,ae.[RANK_AUM]
      ,ae.[AUM]
	  ,CASE WHEN ASSET_CLASS='Credit' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_cred_inter_Filled
	   ,CASE WHEN ASSET_CLASS='Credit' and VEHICLE_WRAPPER='Non-traded BDC' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_cred_bdc_Filled
	   ,CASE WHEN ASSET_CLASS='Credit' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_cred_oper_Filled
	   ,CASE WHEN ASSET_CLASS='Other' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_other_oper_Filled
	   ,CASE WHEN ASSET_CLASS='Other' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_other_inter_Filled
	   ,CASE WHEN ASSET_CLASS='PE (Core)' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_pecore_inter_Filled
	   ,CASE WHEN ASSET_CLASS='PE (Core)' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_pecore_oper_Filled
	   ,CASE WHEN ASSET_CLASS='PE (Infra)' and VEHICLE_WRAPPER='PE (Infra)' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_peinfra_pe_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_real_inter_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_real_oper_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='DST 1031 - Opportunity Zone Fund' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_real_dstop_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Non-traded REIT' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_real_reit_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Reg D (506b/506c)' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_real_reg_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='DST/QOZ' THEN
			CASE WHEN ae.[AUM] <> 0 OR ae.[RANK_AUM] = 0 THEN ae.[AUM] 
	        ELSE ae12aum.[AUM] END 
       END AUM_real_dstqoz_Filled
      ,ae.[REDS_RANK_12MO]
      ,ae.[REDS_12MO]
	  ,CASE WHEN ASSET_CLASS='Credit' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_cred_inter_Filled
	   ,CASE WHEN ASSET_CLASS='Credit' and VEHICLE_WRAPPER='Non-traded BDC' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_cred_bdc_Filled
	   ,CASE WHEN ASSET_CLASS='Credit' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_cred_oper_Filled
	   ,CASE WHEN ASSET_CLASS='Other' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_other_oper_Filled
	   ,CASE WHEN ASSET_CLASS='Other' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_other_inter_Filled
	   ,CASE WHEN ASSET_CLASS='PE (Core)' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_pecore_inter_Filled
	   ,CASE WHEN ASSET_CLASS='PE (Core)' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_pecore_oper_Filled
	   ,CASE WHEN ASSET_CLASS='PE (Infra)' and VEHICLE_WRAPPER='PE (Infra)' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_peinfra_pe_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Interval/Tender Offer Fund' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_real_inter_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Operating Co/Other' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_real_oper_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='DST 1031 - Opportunity Zone Fund' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_real_dstop_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Non-traded REIT' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_real_reit_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='Reg D (506b/506c)' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_real_reg_Filled
	   ,CASE WHEN ASSET_CLASS='Real Estate' and VEHICLE_WRAPPER='DST/QOZ' THEN
			CASE WHEN ae.[REDS_12MO] <> 0 OR ae.[REDS_RANK_12MO] = 0 THEN ae.[REDS_12MO] 
	        ELSE ae12salesreds.[REDS_12MO] END
       END REDS_12MO_real_dstqoz_Filled
  FROM WAL_AD_VEH ae
 OUTER APPLY(SELECT TOP 1 ae12mo.[SALES_12MO]
               FROM WAL_AD_VEH ae12mo
              WHERE ae12mo.[SALES_RANK_12MO] > ae.[SALES_RANK_12MO]
				AND ae12mo.[SALES_12MO] > 0
				ORDER BY ae12mo.[SALES_RANK_12MO] 
            ) ae12mo 
 OUTER APPLY(SELECT TOP 1 ae12mo.[AUM]
               FROM WAL_AD_VEH ae12mo
              WHERE ae12mo.[RANK_AUM] > ae.[RANK_AUM]
				AND ae12mo.[AUM] > 0
				ORDER BY ae12mo.[RANK_AUM] 
            ) ae12aum
 OUTER APPLY(SELECT TOP 1 ae12mo.[REDS_12MO]
               FROM WAL_AD_VEH ae12mo
              WHERE ae12mo.[REDS_RANK_12MO] > ae.[REDS_RANK_12MO]
				AND ae12mo.[REDS_12MO] > 0
				ORDER BY ae12mo.[REDS_RANK_12MO] 
            ) ae12salesreds
GO


